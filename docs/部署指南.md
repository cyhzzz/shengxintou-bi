# 省心投 BI - 部署指南

本文档详细说明省心投 BI 系统的部署流程，包括开发环境、测试环境和生产环境的配置。

## 目录

1. [环境要求](#环境要求)
2. [开发环境部署](#开发环境部署)
3. [生产环境部署](#生产环境部署)
4. [Docker部署](#docker部署)
5. [性能优化](#性能优化)
6. [监控和日志](#监控和日志)
7. [故障排查](#故障排查)

## 环境要求

### 硬件要求

**最低配置**
- CPU: 2核
- 内存: 4GB
- 硬盘: 20GB

**推荐配置**
- CPU: 4核+
- 内存: 8GB+
- 硬盘: 50GB+ SSD

### 软件要求

- **操作系统**: Linux (Ubuntu 20.04+, CentOS 7+) 或 Windows Server 2016+
- **Python**: 3.8 或更高版本
- **数据库**: SQLite (开发)/ MySQL 5.7+ 或 PostgreSQL 12+ (生产)
- **Web服务器**: Nginx 1.18+ 或 Apache 2.4+
- **浏览器**: Chrome 90+, Firefox 88+, Edge 90+, Safari 14+

## 开发环境部署

### 1. 安装Python环境

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install python3 python3-pip python3-venv

# CentOS/RHEL
sudo yum install python3 python3-pip

# Windows
# 从 https://python.org 下载并安装Python 3.8+
```

### 2. 创建虚拟环境

```bash
# 创建虚拟环境
python3 -m venv venv

# 激活虚拟环境
# Linux/Mac:
source venv/bin/activate

# Windows:
venv\Scripts\activate
```

### 3. 安装依赖

```bash
pip install -r requirements.txt
```

### 4. 初始化数据库

```bash
python -c "from backend import create_app; app = create_app(); \
app.app_context().push(); \
from backend.database import db; \
db.create_all(); \
print('数据库初始化完成')"
```

### 5. 启动开发服务器

```bash
# 方式1: 直接运行
python backend/app.py

# 方式2: 使用Flask命令
export FLASK_APP=backend.app
export FLASK_ENV=development
flask run
```

服务器将在 http://localhost:5000 启动

### 6. 访问前端

```bash
# 方式1: 直接打开文件
# 在浏览器中打开 frontend/index.html

# 方式2: 使用HTTP服务器
cd frontend
python -m http.server 8080
# 访问 http://localhost:8080
```

## 生产环境部署

### 1. 使用系统包管理器安装

#### Ubuntu/Debian

```bash
# 安装系统依赖
sudo apt update
sudo apt install python3 python3-pip python3-venv nginx

# 安装MySQL (可选)
sudo apt install mysql-server mysql-client
sudo mysql_secure_installation

# 创建数据库
sudo mysql -u root -p
CREATE DATABASE shengxintou CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'shengxintou'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON shengxintou.* TO 'shengxintou'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

#### CentOS/RHEL

```bash
# 安装系统依赖
sudo yum install python3 python3-pip nginx

# 安装PostgreSQL (可选)
sudo yum install postgresql postgresql-server
sudo postgresql-setup initdb
sudo systemctl start postgresql
sudo systemctl enable postgresql

# 创建数据库
sudo -u postgres psql
CREATE DATABASE shengxintou;
CREATE USER shengxintou WITH PASSWORD 'your_password';
GRANT ALL PRIVILEGES ON DATABASE shengxintou TO shengxintou;
\q
```

### 2. 配置应用

#### 创建配置文件 `.env`

```bash
# 复制示例配置
cp .env.example .env

# 编辑配置
nano .env
```

`.env` 文件内容:

```bash
# Flask配置
FLASK_APP=backend.app
FLASK_ENV=production
SECRET_KEY=your-secret-key-here

# 数据库配置
# SQLite (默认)
DATABASE_URL=sqlite:///shengxintou.db

# MySQL
# DATABASE_URL=mysql+pymysql://shengxintou:password@localhost/shengxintou

# PostgreSQL
# DATABASE_URL=postgresql://shengxintou:password@localhost/shengxintou

# 上传配置
UPLOAD_FOLDER=/var/www/shengxintou/uploads
MAX_CONTENT_LENGTH=104857600

# 日志配置
LOG_LEVEL=INFO
LOG_FILE=/var/log/shengxintou/app.log
```

### 3. 使用Gunicorn运行

#### 安装Gunicorn

```bash
pip install gunicorn gevent
```

#### 创建Gunicorn配置文件 `gunicorn.conf.py`

```python
import multiprocessing

# 服务器地址
bind = "127.0.0.1:5000"

# 工作进程数 (建议: CPU核心数 * 2 + 1)
workers = multiprocessing.cpu_count() * 2 + 1

# 工作模式
worker_class = "gevent"
worker_connections = 1000

# 超时时间
timeout = 120
keepalive = 5

# 日志
accesslog = "/var/log/shengxintou/gunicorn_access.log"
errorlog = "/var/log/shengxintou/gunicorn_error.log"
loglevel = "info"

# 进程名称
proc_name = "shengxintou_bi"

# 守护进程
daemon = False

# 重新启动
max_requests = 1000
max_requests_jitter = 50

# 预加载应用
preload_app = True

# 线程数
threads = 2
```

#### 启动服务

```bash
# 测试启动
gunicorn -c gunicorn.conf.py backend.app:app

# 后台启动
gunicorn -c gunicorn.conf.py backend.app:app --daemon
```

### 4. 配置Nginx反向代理

#### 创建Nginx配置 `/etc/nginx/sites-available/shengxintou`

```nginx
# 上游服务器配置
upstream shengxintou_backend {
    server 127.0.0.1:5000;
    keepalive 32;
}

# HTTP服务器配置
server {
    listen 80;
    server_name your-domain.com;

    # 日志
    access_log /var/log/nginx/shengxintou_access.log;
    error_log /var/log/nginx/shengxintou_error.log;

    # 客户端最大请求体大小
    client_max_body_size 100M;

    # 前端静态文件
    location / {
        root /var/www/shengxintou/frontend;
        index index.html;
        try_files $uri $uri/ /index.html;

        # 缓存静态资源
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    # API代理
    location /api/ {
        proxy_pass http://shengxintou_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 超时设置
        proxy_connect_timeout 300;
        proxy_send_timeout 300;
        proxy_read_timeout 300;

        # Buffer设置
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;
    }

    # 上传文件接口
    location /api/upload {
        proxy_pass http://shengxintou_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # 上传文件需要更长超时
        proxy_connect_timeout 600;
        proxy_send_timeout 600;
        proxy_read_timeout 600;
        client_max_body_size 100M;
    }

    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript
               application/json application/javascript application/xml+rss
               application/rss+xml font/truetype font/opentype
               application/vnd.ms-fontobject image/svg+xml;
}
```

#### 启用配置

```bash
# 创建符号链接
sudo ln -s /etc/nginx/sites-available/shengxintou /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重载Nginx
sudo systemctl reload nginx
```

### 5. 配置systemd服务

创建服务文件 `/etc/systemd/system/shengxintou.service`:

```ini
[Unit]
Description=省心投 BI Backend Application
After=network.target mysql.service postgresql.service

[Service]
Type=notify
User=www-data
Group=www-data
WorkingDirectory=/var/www/shengxintou
Environment="PATH=/var/www/shengxintou/venv/bin"
ExecStart=/var/www/shengxintou/venv/bin/gunicorn -c gunicorn.conf.py backend.app:app
ExecReload=/bin/kill -s HUP $MAINPID
KillMode=mixed
TimeoutStopSec=5
PrivateTmp=true
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

#### 启动和管理服务

```bash
# 重载systemd配置
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start shengxintou

# 设置开机自启
sudo systemctl enable shengxintou

# 查看服务状态
sudo systemctl status shengxintou

# 重启服务
sudo systemctl restart shengxintou

# 查看日志
sudo journalctl -u shengxintou -f
```

## Docker部署

### 1. 创建Dockerfile

```dockerfile
# 使用Python官方镜像作为基础镜像
FROM python:3.9-slim

# 设置工作目录
WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# 复制依赖文件
COPY requirements.txt .

# 安装Python依赖
RUN pip install --no-cache-dir -r requirements.txt
RUN pip install gunicorn gevent

# 复制应用代码
COPY . .

# 创建日志目录
RUN mkdir -p /var/log/shengxintou

# 暴露端口
EXPOSE 5000

# 设置环境变量
ENV FLASK_APP=backend.app
ENV FLASK_ENV=production

# 启动命令
CMD ["gunicorn", "-c", "gunicorn.conf.py", "backend.app:app"]
```

### 2. 创建docker-compose.yml

```yaml
version: '3.8'

services:
  # 后端应用
  backend:
    build: .
    ports:
      - "5000:5000"
    volumes:
      - ./data:/app/data
      - ./logs:/var/log/shengxintou
    environment:
      - FLASK_ENV=production
      - DATABASE_URL=sqlite:///shengxintou.db
    restart: unless-stopped
    depends_on:
      - db
    networks:
      - shengxintou-network

  # MySQL数据库 (可选)
  db:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: shengxintou
      MYSQL_USER: shengxintou
      MYSQL_PASSWORD: password
    volumes:
      - mysql-data:/var/lib/mysql
    restart: unless-stopped
    networks:
      - shengxintou-network

  # Nginx前端服务器
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./frontend:/usr/share/nginx/html
      - ./nginx.conf:/etc/nginx/nginx.conf
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - shengxintou-network

networks:
  shengxintou-network:
    driver: bridge

volumes:
  mysql-data:
```

### 3. 构建和运行

```bash
# 构建镜像
docker-compose build

# 启动服务
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down

# 重启服务
docker-compose restart
```

## 性能优化

### 1. 数据库优化

#### 添加索引

```python
# 在 models.py 中已有索引配置
# 确保执行数据库迁移
db.create_all()
```

#### MySQL优化配置 (`/etc/mysql/my.cnf`)

```ini
[mysqld]
# 连接数
max_connections = 200

# 缓冲池大小 (建议: 物理内存的70-80%)
innodb_buffer_pool_size = 2G

# 日志文件大小
innodb_log_file_size = 256M

# 查询缓存
query_cache_size = 64M
query_cache_type = 1

# 慢查询日志
slow_query_log = 1
long_query_time = 2
```

### 2. 应用层优化

#### 启用缓存

```python
# 安装Flask-Caching
pip install Flask-Caching

# 在应用中配置
from flask_caching import Cache

cache = Cache(config={
    'CACHE_TYPE': 'redis',
    'CACHE_REDIS_URL': 'redis://localhost:6379/0',
    'CACHE_DEFAULT_TIMEOUT': 300
})
```

#### 连接池配置

```python
# SQLAlchemy配置
SQLALCHEMY_ENGINE_OPTIONS = {
    'pool_size': 20,
    'pool_recycle': 3600,
    'pool_pre_ping': True,
    'max_overflow': 40
}
```

### 3. 前端优化

#### 启用CDN

修改 `frontend/index.html`:

```html
<!-- 使用CDN加载ECharts -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
```

#### 资源压缩

```bash
# 安装工具
npm install -g gulp-cli gulp

# 创建gulpfile.js配置压缩任务
```

## 监控和日志

### 1. 应用日志

配置日志记录 (`backend/app.py`):

```python
import logging
from logging.handlers import RotatingFileHandler

# 配置日志
if not os.path.exists('logs'):
    os.mkdir('logs')

file_handler = RotatingFileHandler('logs/app.log', maxBytes=10240, backupCount=10)
file_handler.setFormatter(logging.Formatter(
    '%(asctime)s %(levelname)s: %(message)s [in %(pathname)s:%(lineno)d]'
))
file_handler.setLevel(logging.INFO)

app.logger.addHandler(file_handler)
app.logger.setLevel(logging.INFO)
app.logger.info('省心投 BI startup')
```

### 2. Nginx日志

```bash
# 查看访问日志
sudo tail -f /var/log/nginx/shengxintou_access.log

# 查看错误日志
sudo tail -f /var/log/nginx/shengxintou_error.log
```

### 3. 系统监控

```bash
# 安装监控工具
sudo apt install htop iotop

# 查看系统资源
htop

# 查看磁盘IO
iotop

# 查看网络连接
sudo netstat -tulpn
```

## 故障排查

### 常见问题

#### 1. 服务无法启动

```bash
# 检查服务状态
sudo systemctl status shengxintou

# 查看详细日志
sudo journalctl -u shengxintou -n 50

# 检查端口占用
sudo netstat -tulpn | grep 5000
```

#### 2. 数据库连接失败

```bash
# 检查数据库服务
sudo systemctl status mysql

# 测试连接
mysql -u shengxintou -p shengxintou

# 检查数据库配置
cat .env | grep DATABASE_URL
```

#### 3. 前端无法访问

```bash
# 检查Nginx配置
sudo nginx -t

# 查看Nginx日志
sudo tail -f /var/log/nginx/error.log

# 重启Nginx
sudo systemctl restart nginx
```

#### 4. 性能问题

```bash
# 查看系统资源
top
df -h
free -m

# 检查数据库查询
# 开启慢查询日志
# 使用EXPLAIN分析查询

# 检查应用日志
tail -f /var/log/shengxintou/app.log
```

### 日志分析

```bash
# 统计错误数量
grep "ERROR" /var/log/shengxintou/app.log | wc -l

# 查看最近的错误
grep "ERROR" /var/log/shengxintou/app.log | tail -20

# 分析访问日志
awk '{print $1}' /var/log/nginx/shengxintou_access.log | sort | uniq -c | sort -rn | head -10
```

## 备份和恢复

### 数据库备份

```bash
# MySQL备份
mysqldump -u shengxintou -p shengxintou > backup_$(date +%Y%m%d).sql

# SQLite备份
cp shengxintou.db shengxintou_backup_$(date +%Y%m%d).db

# 定时备份 (crontab)
0 2 * * * /usr/bin/mysqldump -u shengxintou -ppassword shengxintou > /backup/shengxintou_$(date +\%Y\%m\%d).sql
```

### 数据恢复

```bash
# MySQL恢复
mysql -u shengxintou -p shengxintou < backup_20250115.sql

# SQLite恢复
cp shengxintou_backup_20250115.db shengxintou.db
```

## 安全建议

1. **使用HTTPS**: 配置SSL证书 (Let's Encrypt)
2. **防火墙**: 只开放必要端口 (80, 443, 22)
3. **更新**: 定期更新系统和依赖包
4. **备份**: 每日自动备份数据库
5. **监控**: 配置异常告警
6. **权限**: 使用专用账户运行服务，避免root

## 升级指南

```bash
# 1. 备份数据
./backup.sh

# 2. 停止服务
sudo systemctl stop shengxintou

# 3. 拉取新代码
git pull

# 4. 更新依赖
source venv/bin/activate
pip install -r requirements.txt --upgrade

# 5. 执行数据库迁移 (如果有)
python migrate.py

# 6. 重启服务
sudo systemctl start shengxintou

# 7. 验证
curl http://localhost/api/metadata
```

## 技术支持

如遇到部署问题，请:
1. 查看本文档的故障排查部分
2. 检查应用和系统日志
3. 联系技术支持团队
